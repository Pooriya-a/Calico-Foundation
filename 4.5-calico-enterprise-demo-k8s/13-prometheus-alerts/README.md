# Prometheus

Prometheus which is an opensource solution for monitoring and alerting is configured with Calico Enterprise calico-node to monitor the health of BGP peers of the Kubernetes cluster.

Can view the time-series metrics from Calico Enterprise in Prometheus. It monitors high-level operations between BGP peers. 

Prometheus Server deployed as part of the Calico Enterprise scrapes every configured calico-node target. Alerting rules querying BGP metrics can be configured in Prometheus and when triggered, fire alerts to the Prometheus Alertmanager.

Prometheus Alertmanager receives alerts from Prometheus server and forwards alerts to various alerting mechanisms such as Pager Duty, or OpsGenie.

BGP metrics are generated within calico-nodes every 5 minutes using statistics pulled from the BIRD daemon. The metrics generated are:

```1. bgp_peers - Total number of peers with a specific BGP connection status```

```2. bgp_routes_imported - Current number of routes successfully imported into the routing table.```

```3. bgp_route_updates_received - Total number of route updates received over time (since startup)..```

#### Note: Metrics are directly available on each compute node at http://<node-IP>:9900/metrics.

We can use the Prometheus monitoring and alerting tool to get Calico Enterprise license metrics. But this is an advanced topic and can be covered later.

Calico Enterprise adds the ability to monitor effects of policies configured in your cluster. By defining a set of simple rules and thresholds, you can monitor traffic metrics and receive alerts when it exceeds configured thresholds.

Have 4 key pieces helping the Policy inspection and reporting.

1. A Calico Enterprise specific Felix binary running inside calico-node container monitors the host for denied/allowed packets and collects metrics.

2. Prometheus Server(s) deployed as part of the Calico Enterprise manifest scrapes every configured calico-node target. Alerting rules querying denied packet metrics are configured in Prometheus and when triggered, fire alerts to the Prometheus Alertmanager.

3. Prometheus Alertmanager (or simply Alertmanager), deployed as part of the Calico Enterprise manifest, receives alerts from Prometheus and forwards alerts to various alerting mechanisms such as Pager Duty, or OpsGenie.

4. Calico Enterprise Manager, also deployed as part of the Calico Enterprise manifest, processes the metrics using pre-defined Prometheus queries and provides dashboards and associated workflows.

Metrics will only be generated at a node when there are packets directed at an endpoint that are being actively profiled by a policy. Once generated they stay alive for 60 seconds.

Metrics generated by Calico node.

1. calico_denied_packets - Total number of packets denied by Calico Enterprise policies.
2. calico_denied_bytes - Total number of bytes denied by Calico Enterprise policies.
3. cnx_policy_rule_packets - Sum of allowed/denied packets over rules processed by Calico Enterprise policies.
4. cnx_policy_rule_bytes - Sum of allowed/denied bytes over rules processed by Calico Enterprise policies.
5. cnx_policy_rule_connections - Sum of connections over rules processed by Calico Enterprise policies.

The metrics calico_denied_packets and calico_denied_bytes have the labels policy and srcIP. Using these two metrics, one can identify the policy that denied packets as well as the source IP address of the packets that were denied by this policy. 

The metrics cnx_policy_rule_packets, cnx_policy_rule_bytes and cnx_policy_rule_connections have the labels: tier, policy, namespace, rule_index, action, traffic_direction, rule_direction.

### Lab: Prometheus configuration, rule creation and checking alerts

In this lab we will make the required configuration to view the metrics entry, create a Prometheus rule/alert and will view the generated alert.

1. Felix configuration - This will enable Felix to keep track of additional metrics information provided by calico-node. Edit felix configuration and add the below field entries.

&nbsp;&nbsp;&nbsp;&nbsp; ```prometheusMetricsEnabled: true```

&nbsp;&nbsp;&nbsp;&nbsp; ```prometheusReporterEnabled: true```

2. Create a dummy rule which will generate alert when the total number of denied packets are greater than 50. Please refer prometheus_rule.yaml.

3. Apply a Egress-deny policy. Refer egress-deny.yaml. This will generate denied_packets.

4. Accessing Alert manager and Prometheus on Web UI. This is in addition to the Tigera Manager UI.

&nbsp;&nbsp;&nbsp;&nbsp; ```http://<master node public IP>:30004```

&nbsp;&nbsp;&nbsp;&nbsp; ```http://<master node public IP>:30005```
